{% extends "base.html" %}
{% block title %}Forgot Password | Byte Business{% endblock %}

{% set turnstile_site_key = config.get('TURNSTILE_SITE_KEY', '') %}

{% block head %}
  {{ super() }}
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.querySelector('[data-forgot-form]');
      const tokenInput = document.getElementById('cf-turnstile-response');
      const submitButton = document.querySelector('[data-submit]');
      const widget = document.querySelector('.cf-turnstile');
      const hasSiteKey = widget && widget.dataset.sitekey;

      const updateSubmitState = () => {
        if (!submitButton) return;
        const hasToken = tokenInput && tokenInput.value;
        submitButton.disabled = !hasToken;
        submitButton.textContent = hasToken ? 'Send reset link' : 'Complete verification';
      };

      if (!hasSiteKey) {
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = 'Verification unavailable';
        }
        return;
      }

      window.handleForgotTurnstile = (token) => {
        if (tokenInput) tokenInput.value = token;
        updateSubmitState();
      };

      window.handleForgotTurnstileExpired = () => {
        if (tokenInput) tokenInput.value = '';
        updateSubmitState();
      };

      window.handleForgotTurnstileError = () => {
        if (tokenInput) tokenInput.value = '';
        updateSubmitState();
      };

      form?.addEventListener('submit', (event) => {
        if (!tokenInput || !tokenInput.value) {
          event.preventDefault();
          updateSubmitState();
        }
      });

      updateSubmitState();
    });
  </script>
{% endblock %}

{% block content %}
<div class="container auth-layout">
  <div class="auth-card">
    <h1>Forgot password</h1>
    <p>Enter your email and we will send a secure reset link.</p>
    <form method="POST" action="{{ url_for('forgot_password.forgot_password') }}" data-forgot-form>
      <div>
        <label for="email">Email</label>
        <input id="email" name="email" type="email" placeholder="you@example.com" required>
      </div>
      <div>
        <label>Verification</label>
        <div
          class="cf-turnstile"
          data-sitekey="{{ turnstile_site_key }}"
          data-theme="light"
          data-callback="handleForgotTurnstile"
          data-expired-callback="handleForgotTurnstileExpired"
          data-error-callback="handleForgotTurnstileError"
        ></div>
        {% if not turnstile_site_key %}
        <p class="muted" style="margin: 0.35rem 0 0;">Turnstile site key missing. Add <code>TURNSTILE_SITE_KEY</code> to your config/env to enable verification.</p>
        {% endif %}
        <input type="hidden" name="cf-turnstile-response" id="cf-turnstile-response">
      </div>
      <button class="button" type="submit" data-submit>Send reset link</button>
    </form>
    <p class="muted" style="margin-top: 1rem;">Remembered it? <a href="{{ url_for('auth.login') }}">Back to login</a>.</p>
  </div>
</div>
{% endblock %}
